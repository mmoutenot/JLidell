<!doctype html>
<html>
    <head>
    </head>
    <body>

        <style type="text/css">
            #redCanvas {
                position:absolute;
                top: 0;
                left:0;
            }

            #blueCanvas {
//                display:none;
            }

            #resultCanvas {
                position:absolute;
            }

            #redImg {
                width:500px;
                height:393px;
            }

            #blueImg{
//                display:none;
                width:500px;
                height:393px;
            }

        </style>

        <img src="red_s.png" alt="red_source" id="redImg">
        <img src="blue_s.png" alt="blue_source" id="blueImg">

        <script>

            var multiplyFilter = (function() {

                //** private vars **//
                var canvasRed, canvasBlue;
                var redImage, blueImage;

                //** private functions **//

                // takes in name of the canvas to be created
                function createCanvas(image) {
                    var canvas = document.createElement("canvas");

                    // always using redImage because the images should be the
                    // height anyway
                    canvas.width = redImage.clientWidth;
                    canvas.height = redImage.clientHeight;

                    image.parentNode.insertBefore(canvas, image);
                    // no canvas support?
                    if (!canvas.getContext) { return; }

                    return canvas;
                }

                function draw() {
                    var pix;
                    console.log(redImage);
                    var w = redImage.clientWidth;
                    var h = redImage.clientHeight;
                    console.log("writing image of (height,width): " + h + " " + w);
                    // get 2d context
                    contextRed  = canvasRed.getContext('2d');
                    contextRed.drawImage(redImage, 0, 0);
                    redData = contextRed.getImageData(0,0,w,h);
                    console.log(redData);
                    pix = redData.data; // project the blue pixels onto the red pixels

                    contextBlue = canvasBlue.getContext('2d');
                    contextBlue.drawImage(blueImage, 0, 0);
                    blueData = contextBlue.getImageData(0,0,w,h);
                    bluePixels = blueData.data;

                    // Loop over each pixel and change the color.
                    for (var i = 0, n = pix.length; i < n; i += 4) {
                        pix[i  ] = multiplyPixels(bluePixels[i  ], pix[i  ]); // red
                        pix[i+1] = multiplyPixels(bluePixels[i+1], pix[i+1]); // green
                        pix[i+2] = multiplyPixels(bluePixels[i+2], pix[i+2]); // blue
                        // pix[i+3] is alpha channel (ignored)

                        // another check to see if image is still empty
//                        if(i < 5 && !pix[i] && !pix[i+1] && !pix[i+2] && !pix[i+3]) {
//                            canvas.parentNode.removeChild(canvas);
//                            setTimeout(function() { multiplyFilter.init("redImg","blueImg"); }, 500);
//                            return false;
//                        }
                    }
                    // Draw the result on the canvas
                    contextRed.putImageData(redData, 0, 0);
                }

                //** helper function **//
                function multiplyPixels(topValue, bottomValue) {
                    // the multiply formula
                    return topValue * bottomValue / 255;
                }


                //** public functions **//
                return {
                    init : function(redId, blueId) {
                        console.log("multiply filter with " + redId + " " + blueId);
                        redImage = document.getElementById(redId);
                        blueImage = document.getElementById(blueId);

                        // lauch the draw function as soon as the image is loaded
                        if(redImage && blueImage) { // images loaded
                            console.log("Images ready");
                            canvasRed = createCanvas(redImage);
                            canvasBlue = createCanvas(blueImage);
                            draw();
                        } else { // not yet ready
                            console.log("Images not ready");
                            setTimeout(function() { multiplyFilter.init("redImg", "blueImg"); }, 1000);
                        }
                    }
                }
            })();

            multiplyFilter.init("redImg", "blueImg");

        </script>
    </body>
</html>

